<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Mining Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300,400,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Open+Sans:wght@400,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #0A1C3C; /* Very dark blue */
            --secondary-bg: #102B50; /* Slightly lighter dark blue for main container */
            --card-bg: #0C2140; /* Even darker blue for upgrade cards */
            --text-color: #E0E0E0; /* Light gray */
            --accent-color: #4CAFEE; /* Bright sky blue for "Crypto" part of title/highlights */
            --button-gradient-start: #81C784; /* Softer green */
            --button-gradient-end: #4CAF50; /* Darker green */
            --shadow-color: rgba(0, 0, 0, 0.25); /* Softer shadow color */
            --border-radius: 10px; /* Slightly larger border radius */
            --padding-base: 25px; /* Slightly more padding */
            --success-color: #66BB6A; /* Softer green for positive effects */
            --purchased-color: #263238; /* Darker gray/blue for purchased button state */
            --card-gradient-start: #1A3A60; /* Darker blue for card base */
            --card-gradient-end: #0A1C3C; /* Even darker blue for card end */
            --tab-inactive-bg: #1A3A60; /* Dark blue */
            --tab-active-bg: var(--accent-color); /* Light blue */
            --tab-hover-bg: #64B5F6; /* Lighter blue for hover */
        }

        body {
            font-family: 'Open Sans', sans-serif; /* Changed to Open Sans for general text */
            margin: 0;
            padding: 0;
            background: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center; /* Center vertically as well */
            min-height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
            position: relative; /* For pseudo-element background */
            z-index: 1; /* Ensure content is above background */
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Linear gradient from the reference image */
            background: linear-gradient(135deg, var(--primary-bg) 0%, #1A3A60 100%);
            background-size: cover; /* Cover the entire area */
            animation: none; /* Remove subtleShift animation */
            z-index: -1; /* Place behind content */
        }

        /* Removed @keyframes subtleShift as it's no longer used */

        .game-container {
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px var(--shadow-color); /* Softer, less prominent shadow */
            padding: var(--padding-base);
            margin: 30px; /* More margin */
            max-width: 950px; /* Slightly wider */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: var(--padding-base);
            border: 1px solid rgba(76, 175, 238, 0.2); /* Subtle border using accent color */
        }

        header {
            text-align: center;
            padding-bottom: 20px; /* More padding */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Lighter, subtle border */
        }

        h1 {
            color: var(--text-color); /* Default color for h1 part */
            margin-bottom: 8px; /* More margin */
            font-weight: 700;
            /* Removed text-shadow for flatter look */
            font-family: 'Montserrat', sans-serif; /* Apply Montserrat for titles */
            font-size: 2.5em; /* Make it larger */
        }

        .crypto-title-part {
            color: var(--accent-color); /* Bright blue for "Crypto" */
        }

        .mining-title-part {
            color: var(--text-color); /* White for "Mining Simulator" */
        }

        .tagline {
            font-size: 1.1em; /* Slightly larger */
            color: #a0a0a0;
            font-weight: 400; /* Less bold */
        }

        /* Updated mining-stats section to only contain the crypto card */
        .mining-stats {
            display: flex;
            justify-content: center; /* Center the single crypto card */
            align-items: flex-start;
            padding: 10px 0; /* Just some vertical padding */
            /* Removed background, padding, shadow, border to avoid redundancy with crypto-card's strong styling */
            gap: 0; /* No gap needed if only one item */
        }

        .stat-item {
            text-align: center;
            /* Flex properties handled by parent containers where appropriate */
            padding: 10px 5px; /* Keep individual item padding for consistency if they're used outside flex */
            box-sizing: border-box;
        }

        /* Crypto Card Specific Styling */
        #crypto-card {
            background: linear-gradient(135deg, var(--card-gradient-start), var(--card-gradient-end));
            color: white;
            padding: 30px 35px; /* Increased padding for less squished look */
            border-radius: 10px; /* Slightly less rounded for flatter look */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* Softer shadow for card */
            flex-basis: 380px; /* Slightly wider for less squished look */
            height: 250px; /* Increased height for less squished look */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start; /* Align contents to start */
            text-align: left; /* Align text within card to left */
            flex-grow: 0; /* Prevent it from growing too much */
            flex-shrink: 0; /* Prevent it from shrinking too much */
            overflow: hidden; /* Ensure chip doesn't overflow */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
            margin-bottom: 10px; /* Tighter margin */
        }

        .card-brand {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600; /* Slightly less bold for brand */
            font-size: 1.1em;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.8);
        }

        .card-logo {
            font-family: 'Roboto', sans-serif; /* Keep Roboto for card details */
            font-weight: 700;
            font-size: 1.2em; /* Smaller, as brand is separate */
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: none; /* Remove glow effect */
            display: flex; /* To align text and icon */
            align-items: center;
        }

        /* Coin icon styling */
        .coin-icon {
            height: 22px; /* Slightly smaller for card header icon */
            vertical-align: middle;
            margin-left: 8px; /* Space between text and icon */
            filter: none; /* Remove glow */
        }

        .card-number {
            font-family: 'Roboto Mono', monospace; /* Use a monospace font for card number */
            font-size: 1.6em; /* Slightly larger for less squished look */
            letter-spacing: 3px;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.9);
        }

        .card-number span {
            margin-right: 5px; /* Space between groups of numbers */
        }

        .card-number .last-digits {
            font-weight: bold;
        }

        /* New container for balance and mining rate */
        .card-balance-info {
            width: 100%;
            margin-top: auto; /* Push to bottom, above footer */
            text-align: left;
            margin-bottom: 15px; /* Space between info and footer */
        }

        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            width: 100%;
        }

        #crypto-card .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85em;
            margin-bottom: 2px;
            font-weight: 600; /* Slightly bolder */
        }

        #crypto-card .stat-value {
            font-size: 2.8em; /* Larger balance display for less squished look */
            color: var(--text-color);
            text-shadow: none; /* Remove initial shadow */
            letter-spacing: 1px;
            white-space: nowrap; /* Prevent wrapping */
            transition: font-size 0.2s ease-out; /* Add transition for smooth font size changes */
        }

        /* New classes for dynamic font sizing */
        #crypto-card .stat-value.balance-small-font {
            font-size: 2.2em; /* Smaller for larger numbers */
        }

        #crypto-card .stat-value.balance-smaller-font {
            font-size: 1.7em; /* Even smaller */
        }

        #crypto-card .stat-value.balance-smallest-font {
            font-size: 1.3em; /* Smallest for very large numbers */
        }

        #crypto-card .stat-value.pulsing {
            animation: pulseGlowCard 0.5s ease-out forwards;
        }

        @keyframes pulseGlowCard {
            0% { text-shadow: 0 0 5px rgba(255, 255, 255, 0); }
            50% { text-shadow: 0 0 15px rgba(76, 175, 238, 0.8); } /* Blue glow */
            100% { text-shadow: 0 0 5px rgba(255, 255, 255, 0); }
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.8em; /* Slightly larger for less squished look */
            color: rgba(255, 255, 255, 0.6);
        }

        .card-holder {
            font-weight: 500;
            text-transform: uppercase;
        }

        .card-valid-thru {
            font-weight: 500;
        }

        h2 {
            text-align: center;
            margin-top: 15px; /* More margin */
            color: var(--text-color); /* Changed to text color for consistency */
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            font-size: 2em;
        }

        /* Tab Navigation Styling */
        .tab-navigation {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .tab-button {
            background-color: var(--tab-inactive-bg);
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .tab-button:hover:not(.active) {
            background-color: var(--tab-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(76, 175, 238, 0.25); /* Softer blue shadow on hover */
        }

        .tab-button.active {
            background-color: var(--tab-active-bg);
            font-weight: 700;
            box-shadow: 0 3px 8px rgba(76, 175, 238, 0.4); /* Softer blue glow for active tab */
        }

        /* Tab Content Wrapper for Animations */
        .tab-content-wrapper {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        .tab-content-wrapper.active-tab-content {
            opacity: 1;
            transform: translateY(0);
        }

        .upgrade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .upgrade-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: calc(var(--padding-base) / 1.2); /* More padding */
            box-shadow: 0 6px 18px var(--shadow-color); /* Softer shadow */
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px; /* Taller cards */
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease, filter 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.08); /* Subtle border */
        }

        .upgrade-card:hover {
            transform: translateY(-5px); /* Lift more on hover */
            box-shadow: 0 8px 20px rgba(76, 175, 238, 0.4); /* Softer accent color glow */
        }

        .upgrade-card.purchased-display {
            border: 1px solid var(--success-color); /* Green border for purchased items */
            box-shadow: 0 8px 20px rgba(102, 187, 106, 0.3); /* Green shadow */
            cursor: default;
            transform: none; /* No lift on hover for purchased display */
            opacity: 0.8; /* Slight opacity reduction for purchased */
            filter: grayscale(20%); /* Desaturate slightly */
        }

        .upgrade-card.purchased-display:hover {
            transform: none;
            box-shadow: 0 8px 20px rgba(102, 187, 106, 0.3); /* Maintain green shadow */
        }

        .upgrade-card h3 {
            margin-top: 5px;
            color: var(--text-color);
            font-weight: 600; /* Slightly bolder */
            font-size: 1.3em;
        }

        .upgrade-card p {
            font-size: 1em; /* Slightly larger */
            color: #c0c0c0;
            flex-grow: 1;
            margin-bottom: 10px;
        }

        .upgrade-effect {
            font-weight: 700;
            color: var(--accent-color); /* Use accent color */
            margin-bottom: 15px; /* More margin */
            font-size: 1.1em;
        }

        .upgrade-card button {
            background: linear-gradient(45deg, var(--button-gradient-start), var(--button-gradient-end));
            color: #212121; /* Darker text for better contrast on orange/gold */
            border: none;
            padding: 14px 25px; /* Larger padding */
            border-radius: 7px; /* Slightly more rounded buttons */
            font-size: 1.2em; /* Larger font */
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, background 0.2s ease;
            margin-top: 15px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Button shadow */
        }

        .upgrade-card button:hover:not(:disabled) {
            transform: translateY(-3px); /* Lift more */
            box-shadow: 0 6px 18px rgba(129, 199, 132, 0.4); /* Softer green glow on button hover */
        }

        .upgrade-card button:disabled {
            background: var(--purchased-color); /* Greyer for disabled */
            cursor: not-allowed;
            opacity: 0.7; /* Slightly less opaque */
            box-shadow: none;
            transform: none;
        }

        .upgrade-card button:disabled.purchased {
            background: var(--purchased-color);
            cursor: default;
            opacity: 1; /* Keep full opacity for purchased */
            color: #b0b0b0; /* Lighter text for purchased */
            font-weight: 500;
        }

        .upgrade-card .cost {
            font-weight: bold;
        }

        .no-upgrades-message {
            text-align: center;
            font-size: 1.2em;
            color: #a0a0a0;
            padding: 50px 20px;
            grid-column: 1 / -1; /* Make it span all columns */
        }

        /* Styles for the message area */
        #message-area {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px); /* Initial position slightly above, for fade-in effect */
            background-color: rgba(0, 128, 0, 0.9); /* Default success green */
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            pointer-events: none; /* Allow clicks to pass through */
            text-align: center;
            font-weight: bold;
            box-shadow: 0 44px 15px rgba(0, 0, 0, 0.4);
        }

        #message-area.error {
            background-color: rgba(200, 0, 0, 0.9); /* Error red */
        }

        @media (max-width: 768px) {
            .game-container {
                margin: 20px;
                padding: 20px;
            }

            .upgrade-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            #crypto-card {
                flex-basis: auto; /* Allow card to resize */
                width: 100%; /* Take full width on smaller screens */
                height: auto; /* Auto height */
            }

            .tab-button {
                font-size: 1em;
                padding: 10px 15px;
            }
        }

        @media (max-width: 600px) {
            .game-container {
                margin: 10px;
                padding: 15px;
            }

            .mining-stats {
                flex-direction: column; /* Keep column for consistency if other items added later */
                gap: 20px;
            }

            .upgrade-grid {
                grid-template-columns: 1fr;
            }

            .upgrade-card button {
                padding: 12px 20px;
                font-size: 1.1em;
            }

            #crypto-card .stat-value {
                font-size: 2.2em; /* Adjusted for smaller screens */
            }

            /* Further dynamic font sizing adjustments for smaller screens */
            #crypto-card .stat-value.balance-small-font {
                font-size: 1.8em; /* Adjusted for smaller base */
            }
            #crypto-card .stat-value.balance-smaller-font {
                font-size: 1.4em; /* Adjusted for smaller base */
            }
            #crypto-card .stat-value.balance-smallest-font {
                font-size: 1.1em; /* Adjusted for smaller base */
            }

            .card-number {
                font-size: 1.3em; /* Adjusted for smaller screens */
            }

            h1 {
                font-size: 2em; /* Adjusted for smaller screens */
            }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                
            }
        }
    </script>
</head>
<body>
    <div class="game-container">
        <header>
            <h1><span class="crypto-title-part">Crypto</span> <span class="mining-title-part">Mining Simulator</span></h1>
            <p class="tagline">Mine virtual crypto and upgrade your rigs!</p>
        </header>

        <section class="mining-stats">
            <div id="crypto-card" class="stat-item">
                <div class="card-header">
                    <span class="card-brand">CRPT Corp.</span> <!-- Added brand name -->
                    <span class="card-logo">CRPT COIN <img src="/crypto_coin_icon.png" alt="CRPT Icon" class="coin-icon"></span>
                </div>
                
                <div class="card-number">
                    <span>••••</span> <span>••••</span> <span>••••</span> <span class="last-digits">1234</span>
                </div>
                <div class="card-balance-info"> <!-- Wrapper for both balance and rate -->
                    <div class="balance-row">
                        <span class="stat-label">Balance:</span>
                        <span id="crypto-balance" class="stat-value">0.00 CRPT</span>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="card-holder">VIRTUAL MINER</span>
                    <span class="card-valid-thru">VALID THRU 99/99</span>
                </div>
            </div>
        </section>

        <section class="upgrades">
            <h2>Upgrades</h2>
            <div class="tab-navigation">
                <button class="tab-button active" data-category="gpus">GPUs</button>
                <button class="tab-button" data-category="cpus">CPUs</button>
                <button class="tab-button" data-category="cooling">Cooling</button>
                <button class="tab-button" data-category="asic">ASIC Miners</button>
                <button class="tab-button" data-category="infrastructure">Infrastructure</button>
                <button class="tab-button" data-category="purchased">My Upgrades</button>
            </div>
            <div id="upgrade-content">
                <div class="tab-content-wrapper">
                    <div class="upgrade-grid">
                        <!-- Upgrades will be rendered here dynamically -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Temporary Message Area -->
    <div id="message-area"></div>

    <script>
        // Global variables for audio
        let audioContext = null;
        let audioContextInitialized = false;
        const soundBuffers = {};

        // Function to initialize AudioContext and load sounds
        // This should be triggered by the first user gesture to comply with browser autoplay policies
        async function initAudioContextOnce() {
            if (!audioContextInitialized) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContextInitialized = true;
                console.log("AudioContext initialized.");

                // Load all sounds
                await loadSound('buy', '/buy_upgrade.mp3');
                await loadSound('mine', '/mine_tick.mp3');
                await loadSound('click', '/button_click.mp3');
            }
        }

        // Function to load a single sound
        async function loadSound(name, url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                soundBuffers[name] = await audioContext.decodeAudioData(arrayBuffer);
                console.log(`Sound ${name} loaded.`);
            } catch (error) {
                console.error(`Error loading sound ${name}:`, error);
            }
        }

        // Function to play a sound
        function playSound(name, volume = 1.0) {
            if (!audioContextInitialized || !soundBuffers[name]) {
                // Sound not ready or context not initialized by user gesture yet
                return; 
            }
            const source = audioContext.createBufferSource();
            source.buffer = soundBuffers[name];
            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start(0);
        }

        // Function to show a temporary message
        function showMessage(msg, type = 'success') {
            const msgArea = document.getElementById('message-area');
            msgArea.textContent = msg;
            msgArea.className = ''; // Clear previous classes
            msgArea.classList.add(type);
            msgArea.style.opacity = '1';
            msgArea.style.transform = 'translateX(-50%) translateY(0)'; // Move to final position

            setTimeout(() => {
                msgArea.style.opacity = '0';
                msgArea.style.transform = 'translateX(-50%) translateY(-20px)'; // Move up slightly as it fades out
            }, 2500); // Display for 2.5 seconds
        }

        document.addEventListener('DOMContentLoaded', () => {
            let cryptoBalance = 0;
            // The initial mining rate is 0.2 CRPT/sec.
            let miningRate = 0.2; 
            let currentTab = 'gpus'; // Default active tab

            // Get DOM elements
            const balanceDisplay = document.getElementById('crypto-balance');
            const upgradeGrid = document.querySelector('.upgrade-grid');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContentWrapper = document.querySelector('.tab-content-wrapper');

            // Define upgrades
            const upgrades = {
                gpus: {
                    gpu1: { cost: 10, rateIncrease: 0.5, name: "GPU Upgrade v1.0", description: "Boosts mining power with a dedicated graphics processing unit.", purchased: false },
                    gpu2: { cost: 80, rateIncrease: 2.5, name: "Next-Gen GPU Array", description: "Enhances processing with advanced multi-GPU setup.", purchased: false },
                    gpu3: { cost: 400, rateIncrease: 15.0, name: "Quantum GPU Grid", description: "Leverages quantum computing principles for extreme mining.", purchased: false },
                    gpu4: { cost: 1500, rateIncrease: 50.0, name: "Graviton GPU Cluster", description: "Utilizes advanced graviton technology for unparalleled hash rates.", purchased: false },
                    gpu5: { cost: 6000, rateIncrease: 200.0, name: "Neural Network Processor", description: "A specialized AI-powered GPU designed for hyper-efficient mining algorithms.", purchased: false },
                    gpu6: { cost: 25000, rateIncrease: 800.0, name: "Dark Matter GPU Array", description: "Taps into dark matter energy for unprecedented processing power.", purchased: false },
                    gpu7: { cost: 100000, rateIncrease: 3500.0, name: "Cosmic Ray GPU", description: "Captures cosmic rays for instantaneous, hyper-parallel computation.", purchased: false },
                    gpu8: { cost: 400000, rateIncrease: 15000.0, name: "Singularity GPU Core", description: "A theoretical GPU utilizing a micro-singularity for infinite compute density.", purchased: false }
                },
                cpus: {
                    cpu1: { cost: 20, rateIncrease: 0.5, name: "Basic CPU Cluster", description: "Establishes a foundational processing cluster.", purchased: false },
                    cpu2: { cost: 150, rateIncrease: 5.0, name: "Advanced CPU Rack", description: "Integrates high-performance server-grade CPUs.", purchased: false },
                    cpu3: { cost: 700, rateIncrease: 25.0, name: "Neural Processing Unit", description: "Specialized AI chips for highly efficient data processing.", purchased: false },
                    cpu4: { cost: 1800, rateIncrease: 60.0, name: "Ultra Sipolss CPU", description: "Unleash unparalleled processing power with this cutting-edge CPU.", purchased: false },
                    cpu5: { cost: 5500, rateIncrease: 180.0, name: "Fusion Core Processor", description: "Harnesses miniature fusion reactions for extreme computational power.", purchased: false },
                    cpu6: { cost: 22000, rateIncrease: 700.0, name: "Quantum Entanglement CPU", description: "Utilizes quantum entanglement for instant data transfer across processors.", purchased: false },
                    cpu7: { cost: 90000, rateIncrease: 2800.0, name: "Temporal Displacement CPU", description: "Manipulates local spacetime to accelerate computational cycles.", purchased: false },
                    cpu8: { cost: 350000, rateIncrease: 12000.0, name: "Universal Brain Interface", description: "Directly links to a simulated universal consciousness for processing.", purchased: false }
                },
                cooling: {
                    cooling1: { cost: 50, rateIncrease: 1.0, name: "Cooling System", description: "Optimizes hardware performance by preventing overheating.", purchased: false },
                    cooling2: { cost: 300, rateIncrease: 8.0, name: "Liquid Immersion Cooling", description: "Submerges hardware in dielectric fluid for ultimate heat dissipation.", purchased: false },
                    cooling3: { cost: 1200, rateIncrease: 40.0, name: "Cryogenic Cooling Chamber", description: "Achieves near-absolute zero temperatures for peak efficiency.", purchased: false },
                    cooling4: { cost: 4500, rateIncrease: 150.0, name: "Absolute Zero Refrigerator", description: "Maintains optimal temperatures by pushing the limits of physics.", purchased: false },
                    cooling5: { cost: 18000, rateIncrease: 600.0, name: "Dark Energy Sinks", description: "Utilizes exotic physics to dissipate heat into an alternate dimension.", purchased: false },
                    cooling6: { cost: 70000, rateIncrease: 2500.0, name: "Interstellar Radiator Array", description: "Deploys an array of radiators capable of shedding heat into space.", purchased: false }
                },
                asic: {
                    asic1: { cost: 200, rateIncrease: 3.0, name: "ASIC Miner", description: "Specialized hardware designed for highly efficient crypto mining.", purchased: false },
                    asic2: { cost: 750, rateIncrease: 12.0, name: "Industrial ASIC Farm", description: "A compact farm of custom-built ASIC chips.", purchased: false },
                    asic3: { cost: 3000, rateIncrease: 75.0, name: "Quantum Tunneling Miner", description: "Theoretical miner using quantum effects for unparalleled speed.", purchased: false },
                    asic4: { cost: 9000, rateIncrease: 250.0, name: "Interdimensional ASIC Array", description: "Taps into alternate dimensions for hyper-accelerated computation.", purchased: false },
                    asic5: { cost: 35000, rateIncrease: 1000.0, name: "Universal Hashing Chip", description: "A groundbreaking ASIC designed to optimize any cryptographic hash function.", purchased: false },
                    asic6: { cost: 140000, rateIncrease: 4000.0, name: "Time-Warp Miner", description: "Bends local spacetime to perform computations in fractions of a second.", purchased: false }
                },
                infrastructure: {
                    serverfarm1: { cost: 1000, rateIncrease: 10.0, name: "Server Farm Lease", description: "Lease a massive server farm for unparalleled computing power.", purchased: false },
                    datacenter: { cost: 5000, rateIncrease: 50.0, name: "Hyperscale Datacenter", description: "Own and operate a cutting-edge, global datacenter.", purchased: false },
                    planetarynetwork: { cost: 20000, rateIncrease: 200.0, name: "Planetary Mining Network", description: "Connects mining rigs across the globe for distributed power.", purchased: false },
                    solararray: { cost: 75000, rateIncrease: 750.0, name: "Orbital Solar Array", description: "Powers your operations with an enormous space-based solar farm.", purchased: false },
                    quantumfabric: { cost: 250000, rateIncrease: 2500.0, name: "Quantum Fabric Infrastructure", description: "A continent-spanning network utilizing quantum entanglement for instantaneous data transfer.", purchased: false },
                    spacestation: { cost: 1000000, rateIncrease: 10000.0, name: "Deep Space Mining Station", description: "Establishes a self-sufficient mining outpost beyond Earth's orbit.", purchased: false },
                    blackholeharness: { cost: 5000000, rateIncrease: 50000.0, name: "Micro Black Hole Harness", description: "Taps into the Hawking radiation of a controlled micro black hole for energy.", purchased: false }
                }
            };

            // Function to update the display
            function updateDisplay() {
                const balanceText = `${cryptoBalance.toFixed(2)} CRPT`;
                balanceDisplay.textContent = balanceText;

                // Add pulse effect to balance display
                balanceDisplay.classList.add('pulsing');

                // Remove the class after the animation duration to allow re-triggering
                setTimeout(() => {
                    balanceDisplay.classList.remove('pulsing');
                }, 500); // Match CSS animation duration

                // Dynamic font sizing for balance display
                balanceDisplay.classList.remove('balance-small-font', 'balance-smaller-font', 'balance-smallest-font'); // Clear existing size classes

                if (balanceText.length > 22) { // e.g., 10,000,000,000.00 CRPT (23 chars)
                    balanceDisplay.classList.add('balance-smallest-font');
                } else if (balanceText.length > 18) { // e.g., 100,000,000.00 CRPT (19 chars)
                    balanceDisplay.classList.add('balance-smaller-font');
                } else if (balanceText.length > 14) { // e.g., 1,000,000.00 CRPT (15 chars)
                    balanceDisplay.classList.add('balance-small-font');
                }
                // If 14 or less characters, it will use the default font size (2.8em or 2.2em on mobile).

                // Only update button states if not on the "My Upgrades" tab, or if a purchase occurred
                if (currentTab !== 'purchased') {
                    updateUpgradeButtonStates();
                }
            }

            // Function to mine crypto
            function mineCrypto() {
                cryptoBalance += miningRate;
                updateDisplay();
                playSound('mine', 0.3); // Play subtle mine sound, made louder
            }

            // Function to handle upgrade purchases
            function buyUpgrade(upgradeId, category) {
                const upgrade = upgrades[category][upgradeId];

                if (!upgrade || upgrade.purchased) {
                    return; // Already purchased or invalid upgrade
                }

                if (cryptoBalance >= upgrade.cost) {
                    // Added detailed console logs to help debug rate increase issues
                    console.log(`--- Attempting to purchase: ${upgrade.name} ---`);
                    console.log(`Current Balance: ${cryptoBalance.toFixed(2)} CRPT`);
                    console.log(`Current Mining Rate BEFORE purchase: ${miningRate.toFixed(2)} CRPT/sec`);
                    console.log(`Upgrade cost: ${upgrade.cost} CRPT`);
                    console.log(`Upgrade's advertised rate increase (upgrade.rateIncrease): ${upgrade.rateIncrease} CRPT/sec`);

                    cryptoBalance -= upgrade.cost;
                    miningRate += upgrade.rateIncrease; // This is where the rate is increased

                    upgrade.purchased = true; // Mark as purchased
                    updateDisplay();
                    playSound('buy', 0.7); // Play buy sound
                    
                    console.log(`NEW Balance AFTER purchase: ${cryptoBalance.toFixed(2)} CRPT`);
                    console.log(`NEW Mining Rate AFTER purchase: ${miningRate.toFixed(2)} CRPT/sec`);
                    console.log(`Difference in mining rate: ${(miningRate - (miningRate - upgrade.rateIncrease)).toFixed(2)} CRPT/sec (should match advertised increase)`);

                    // Show success message on screen
                    const message = `Purchased "${upgrade.name}"! Rate increased by +${upgrade.rateIncrease.toFixed(2)} CRPT/sec. New total rate: ${miningRate.toFixed(2)} CRPT/sec.`;
                    showMessage(message, 'success');

                    // If the "My Upgrades" tab is currently active, re-render it
                    if (currentTab === 'purchased') {
                        _renderContent('purchased'); // Re-render 'purchased' tab without animation delay
                        tabContentWrapper.classList.add('active-tab-content'); // Ensure it's visible
                    } else {
                        // If we bought an item on a regular tab, its button state needs update
                        updateUpgradeButtonStates();
                    }
                } else {
                    console.log(`Not enough crypto for ${upgrade.name}. Need ${upgrade.cost}, have ${cryptoBalance.toFixed(2)}.`);
                    // Show error message on screen
                    showMessage(`Not enough CRPT for "${upgrade.name}". Need ${upgrade.cost.toFixed(2)} CRPT.`, 'error');
                }
            }

            // Helper function to actually render content into the grid
            function _renderContent(category) {
                upgradeGrid.innerHTML = ''; // Clear current upgrades

                let upgradesToRender = [];

                if (category === 'purchased') {
                    // Collect all purchased upgrades from all categories
                    for (const catKey in upgrades) {
                        for (const upgradeId in upgrades[catKey]) {
                            const upgrade = upgrades[catKey][upgradeId];
                            if (upgrade.purchased) {
                                upgradesToRender.push(upgrade);
                            }
                        }
                    }
                    if (upgradesToRender.length === 0) {
                        upgradeGrid.innerHTML = '<p class="no-upgrades-message">You haven\'t purchased any upgrades yet. Go to other tabs to buy some!</p>';
                        return;
                    }
                } else {
                    // For other categories, render items from that specific category
                    upgradesToRender = Object.values(upgrades[category]);
                }

                upgradesToRender.forEach(upgrade => {
                    const upgradeCard = document.createElement('div');
                    upgradeCard.classList.add('upgrade-card');
                    // Add purchased-display class if applicable, regardless of tab
                    if (upgrade.purchased) {
                        upgradeCard.classList.add('purchased-display');
                    }

                    let buttonHtml = '';
                    if (category !== 'purchased') { // Only show buy button on non-purchased tabs
                        // Find the original key for the upgrade object to pass to buyUpgrade
                        let upgradeKey = null;
                        for (const key in upgrades[category]) {
                            if (upgrades[category][key] === upgrade) {
                                upgradeKey = key;
                                break;
                            }
                        }
                        buttonHtml = `<button data-upgrade-id="${upgradeKey}" data-upgrade-category="${category}">Buy for <span class="cost">${upgrade.cost}</span> CRPT</button>`;
                    } else {
                        // For "My Upgrades" tab, just show status
                        buttonHtml = `<button disabled class="purchased">Purchased!</button>`;
                    }

                    // Always format rate increase to two decimal places for consistency
                    const rateDisplay = upgrade.rateIncrease.toFixed(2);

                    upgradeCard.innerHTML = `
                        <h3>${upgrade.name}</h3>
                        <p>${upgrade.description}</p>
                        <p class="upgrade-effect">+${rateDisplay} CRPT/sec</p>
                        ${buttonHtml}
                    `;
                    upgradeGrid.appendChild(upgradeCard);
                });

                if (category !== 'purchased') {
                    updateUpgradeButtonStates(); // Update states for newly rendered buttons only on purchase tabs
                }
            }

            // Function to render upgrades for the current active tab with animation
            function renderUpgradesForTab(category, immediate = false) {
                if (!immediate && tabContentWrapper.classList.contains('active-tab-content')) {
                    // If not immediate and content is currently active, fade out first
                    tabContentWrapper.classList.remove('active-tab-content');
                    setTimeout(() => {
                        _renderContent(category);
                        tabContentWrapper.classList.add('active-tab-content'); // Fade in new content
                    }, 400); // This delay should match the CSS transition duration for fade-out
                } else {
                    // For initial load or direct updates (e.g., after purchase in 'My Upgrades' tab)
                    _renderContent(category);
                    tabContentWrapper.classList.add('active-tab-content'); // Immediately show
                }
            }

            // Function to update the disabled state of upgrade buttons
            function updateUpgradeButtonStates() {
                // Select all buttons within the current upgrade grid
                const currentUpgradeButtons = upgradeGrid.querySelectorAll('button');

                currentUpgradeButtons.forEach(button => {
                    const upgradeId = button.dataset.upgradeId;
                    const category = button.dataset.upgradeCategory;
                    const parentCard = button.closest('.upgrade-card'); // Get the parent card element

                    // Ensure upgrade object exists before trying to access properties
                    if (upgrades[category] && upgrades[category][upgradeId]) {
                        const upgrade = upgrades[category][upgradeId];

                        if (upgrade.purchased) {
                            button.disabled = true;
                            button.textContent = "Purchased!";
                            button.style.cursor = 'default';
                            button.classList.add('purchased'); // Add class for specific styling
                            if (parentCard) parentCard.classList.add('purchased-display'); // Add class to card
                        } else if (cryptoBalance < upgrade.cost) {
                            button.disabled = true;
                            button.textContent = `Buy for ${upgrade.cost} CRPT`; // Ensure text updates if player spent money elsewhere
                            button.classList.remove('purchased'); // Ensure class is removed if not purchased
                            if (parentCard) parentCard.classList.remove('purchased-display'); // Remove class from card
                        } else {
                            button.disabled = false;
                            button.textContent = `Buy for ${upgrade.cost} CRPT`;
                            button.classList.remove('purchased'); // Ensure class is removed
                            if (parentCard) parentCard.classList.remove('purchased-display'); // Remove class from card
                        }
                    }
                });
            }

            // Add event listeners for tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    playSound('click', 0.5); // Play click sound
                    // Remove 'active' class from all tab buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // Add 'active' class to the clicked button
                    event.target.classList.add('active');

                    currentTab = event.target.dataset.category;
                    renderUpgradesForTab(currentTab); // Render upgrades for the selected tab with animation
                });
            });

            // Add event listener to the upgrade grid itself (event delegation)
            upgradeGrid.addEventListener('click', (event) => {
                if (event.target.tagName === 'BUTTON' && event.target.dataset.upgradeId) {
                    playSound('click', 0.5); // Play click sound for any purchase attempt
                    const upgradeId = event.target.dataset.upgradeId;
                    const category = event.target.dataset.upgradeCategory;
                    buyUpgrade(upgradeId, category);
                }
            });

            // Trigger AudioContext initialization on first user interaction with the body
            // This ensures that audio playback is allowed by browsers (due to autoplay policies)
            document.body.addEventListener('click', initAudioContextOnce, { once: true });
            document.body.addEventListener('keydown', initAudioContextOnce, { once: true });

            // Start mining interval
            setInterval(mineCrypto, 1000); // Mine every second

            // Initial display update and render default tab immediately
            renderUpgradesForTab(currentTab, true);
            updateDisplay();
        });
    </script>
</body>
</html>
